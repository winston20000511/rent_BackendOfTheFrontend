<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/" lang="zh-hant-TW">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/css/booking.css" />
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
	integrity="sha512-tS3S5qG0BlhnQROyJXvNjeEM4UpMXHrQfTGmbQ1gKmelCxlSEBUaxhRBj/EFTzpbP4RVSrpEikbmdJobCvhE3g=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<title>BOOKING</title>


<style>
	.ui-state-default:not(a) {
	    opacity: 0.5 !important; /* ä½¿ç¦ç”¨æ—¥æœŸè®Šæ·¡ */
	    color: #ccc !important;  /* å­—é«”é¡è‰²è®Šæ·¡ */
	    pointer-events: none !important; /* ç¦æ­¢é»æ“Š */
	}
</style>

</head>

<body>
	<div class="wrapper">
		<div id="calendar">
			<div class="header">
				<div class="overlay">
					<h1>é ç´„çœ‹æˆ¿</h1>
				</div>
			</div>
			<div class="monthChange"></div>
		</div>
		<div style="max-width: fit-content; margin-inline: auto" >ğŸ’¡é¸æ“‡æ‚¨è¦çœ‹æˆ¿çš„æ™‚é–“</div>
		<div class="inner-wrap">
			<form>
				<div class="form-name">
					<input type="text" name="name" id="name"
						th:value="${session.loginUsername}" /> <label for="name">æ‚¨çš„
						å§“å</label>
				</div>

				<div class="form-name">
					<input type="email" name="email" id="email"
						th:value="${session.loginUserEmail}" /> <label for="email">æ‚¨çš„
						email</label>
				</div>

				<button type="submit" class="request disabled">
					é ç´„æ—¥æœŸ: <br class="break" /> <span></span> <span class="day"></span>
					<span>é ç´„æ™‚æ®µ: </span> <span class="time"></span>
					<div class="sendRequest"></div>
				</button>
			</form>
		</div>

		<div class="timepicker">
			<div class="owl"></div>
			<div class="fade-l"></div>
			<div class="fade-r"></div>
		</div>
	</div>


	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
		integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.1/jquery-ui.min.js"
		integrity="sha512-MSOo1aY+3pXCOCdGAYoBZ6YGI0aragoQsg1mKKBHXCYPIWxamwOE7Drh+N5CPgGI5SA9IEKJiPjdfqWFWmZtRA=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"
		integrity="sha512-bPs7Ae6pVvhOSiIcyUClR7/q2OAsRiovw4vAkX+zJbw3ShAeeqezq50RIIcIURq7Oa20rW2n2q+fyXBNcU9lrw=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<!-- <script src="/js/booking.js"></script> -->
	<script>
		var url = window.location.pathname.split('/');
var houseId = url[url.length - 1];
var time;
var day;
var month;
var year;
var months = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
var center;

var weekDay;
var fromDate;
var toDate;
var fromTime;
var toTime;
var duration;


$.ajax({
	url: '/api/booking/list',
	type: 'GET',
	dataType: 'json',
	data: {
		houseId: houseId,
	},
	success: function(response) {
		console.log(response);
		weekDay = response.weekDay;
		fromDate = response.fromDate;
		toDate = response.toDate;
		fromTime = response.fromTime;
		toTime = response.toTime;
		duration = response.duration;

		const owl = $(".timepicker .owl");
		owl.empty();

		var startTime = new Date(`1970-01-01T${fromTime}`);
		var endTime = new Date(`1970-01-01T${toTime}`);

		while (startTime < endTime) {
			var nextTime = new Date(startTime.getTime() + duration * 60000); // duration ä»¥åˆ†é˜ç‚ºå–®ä½
			var timeSlot = `${startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}`;

			owl.append(`<div>${timeSlot}</div>`);

			startTime = nextTime;
		}

		todayEqualActive();

		// datepicker è¨­å®šä¸­æ–‡åŒ–
		$.datepicker.regional['zh-TW'] = {
			clearText: 'æ¸…é™¤',
			closeText: 'é—œé–‰',
			prevText: '< ä¸Šå€‹æœˆ',
			nextText: 'ä¸‹å€‹æœˆ >',
			currentText: 'ä»Šå¤©',
			monthNames: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"],
			monthNamesShort: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "åäºŒ"],
			dayNames: ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'],
			dayNamesShort: ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'],
			dayNamesMin: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'],
			dateFormat: 'yy-mm-dd',
			firstDay: 1
		};
		$.datepicker.setDefaults($.datepicker.regional['zh-TW']);


		$('#calendar').datepicker({
			inline: true,
			firstDay: 1,
			minDate: fromDate,
			maxDate: toDate,
			showOtherMonths: true,
			beforeShowDay: function(date) {
				var day = date.getDay();
				var convertedDay = (day === 0) ? 6 : (day - 1);
				var isDisabled = weekDay.charAt(convertedDay) === '0'; // å¦‚æœè©²æ—¥ç‚º '0'ï¼Œè¡¨ç¤ºç¦ç”¨

				return [!isDisabled, ""]; // å¦‚æœ isDisabled ç‚º trueï¼Œå‰‡ç¦ç”¨è©²æ—¥æœŸ
			},
			dateFormat: 'yy-mm-dd',
			onChangeMonthYear: function() {
				todayEqualActive();
			},
			onSelect: function(dateText, inst) {
				var date = $(this).datepicker('getDate'),
					day = date.getDate(),
					month = date.getMonth() + 1,
					year = date.getFullYear();

				// display day and month on submit button
				var monthName = months[month - 1];
				$(".request .day").text(year + "å¹´" + monthName + " " + day + "æ—¥");

				todayEqualActive();

				$(".request").removeClass("disabled");

				var index;

				setTimeout(function() {
					$(".ui-datepicker-calendar tbody tr").each(function() {
						if ($(this).find(".ui-datepicker-current-day").length) {
							index = $(this).index() + 1;
						}
					});

					// insert timepiker placeholder after selected row
					$("<tr class='timepicker-cf'></tr>")
						.insertAfter($(".ui-datepicker-calendar tr")
							.eq(index));

					var top = $(".timepicker-cf").offset().top - 2;

					if ($(".timepicker").css('height') == '60px') {
						$(".timepicker-cf").animate({
							'height': '0px'
						}, { duration: 200, queue: false });
						$(".timepicker").animate({
							'top': top
						}, 200);
						$(".timepicker-cf").animate({
							'height': '60px'
						}, 200);
					}
					else {
						$(".timepicker").css('top', top);
						$(".timepicker, .timepicker-cf").animate({
							'height': '60px'
						}, 200);
					}
				}, 0);

				// display time on submit button
				time = $(".owl-stage .center").text();
				$(".request .time").text(getTimeSlot(time, duration));


				$(".owl-item").removeClass("center-n");
				center = $(".owl-stage").find(".center");
				center.prev("div").addClass("center-n");
				center.next("div").addClass("center-n");
			}
		});

		// if the inputs arent empty force ":focus state"
		$(".form-name input").each(function() {
			var $input = $(this);
			var $label = $input.siblings("label");

			// åˆå§‹æª¢æŸ¥ï¼Œå¦‚æœè¼¸å…¥æ¡†æœ‰å€¼ï¼Œå‰‡ç§»å‹•æ¨™ç±¤
			if ($input.val()) {
				$label.css({
					'font-size': '0.8em',
					'left': '.15rem',
					'top': '0%'
				});
			}

			// ç•¶ç”¨æˆ¶åœ¨è¼¸å…¥æ¡†ä¸­éµå…¥æ™‚
			$input.on('keyup', function() {
				if ($input.val()) {
					// å¦‚æœæœ‰å€¼ï¼Œä¿æŒæ¨™ç±¤æ¨£å¼
					$label.css({
						'font-size': '0.8em',
						'left': '.15rem',
						'top': '0%'
					});
				} else {
					// å¦‚æœæ²’æœ‰å€¼ï¼Œç§»é™¤æ¨£å¼
					$label.removeAttr("style");
				}
			});
		});

		$(".timepicker").on('click', '.owl-next', function() {
			updateTimeAndCenter();
		});

		$(".timepicker").on('click', '.owl-prev', function() {
			updateTimeAndCenter();
		});

		$(".timepicker").on('click', '.owl-item', function() {
			$(".owl-carousel").trigger("to.owl.carousel", [$(this).index(), 300]); // ç§»å‹•åˆ°é»æ“Šçš„é …ç›®
			setTimeout(updateTimeAndCenter, 350);
		});


		$('.owl').owlCarousel({
			center: true,
			loop: true,
			items: 5,
			dots: false,
			nav: true,
			navText: " ",
			mouseDrag: false,
			touchDrag: true,
			responsive: {
				0: {
					items: 3
				},
				700: {
					items: 5
				},
				1200: {
					items: 7
				}
			}
		});

		$(document).on('click', '.ui-datepicker-next', function(e) {
			$(".timepicker-cf").hide(0);
			$(".timepicker").css({
				'height': '0'
			});
			e.preventDefault();
			$(".ui-datepicker").animate({
				"-webkit-transform": "translate(100%,0)"
			}, 200);
		});

		$(document).on('click', '.ui-datepicker-prev', function() {
			$(".timepicker-cf").hide(0);
			$(".timepicker").css({
				'height': '0'
			});
			$(".ui-datepicker").animate({
				'transform': 'translateX(-100%)'
			}, 200);
		});

		$(window).on('resize', function() {
			var timepickerCf = $(".timepicker-cf");

			if (timepickerCf.length > 0) {
				$(".timepicker").css('top', timepickerCf.offset().top - 2);
			}
		});

	},
	errer: function(err) {
		console.log("ERR!!!!!!!!!!!!!!!");
	}
});


$(".request").on("click", function(e) {
	e.preventDefault();

	var name = $("#name").val();
	var email = $("#email").val();

	if (name === "" || email === "") {
		alert("è«‹å¡«å¯«å§“åå’Œemailï¼");
		return;
	}

	var date = $(".request .day").text();
	var time = $(".request .time").text();

	// ç¢ºèªæ—¥æœŸå’Œæ™‚é–“æ˜¯å¦é¸æ“‡
	if (date === "" || time === "") {
		alert("è«‹é¸æ“‡é ç´„æ—¥æœŸå’Œæ™‚æ®µï¼");
		return;
	}

	var formData = {
		name: name,
		email: email,
		date: date,
		time: time
	};

	$.ajax({
		url: '/api/house/book', 
		type: 'POST',
		data: formData,
		success: function(response) {
			alert("é ç´„æˆåŠŸï¼"); 
		},
		error: function(xhr, status, error) {
			alert("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
		}
	});

});



// å¦‚æœæ‰€é¸æ—¥æœŸæ˜¯ä»Šå¤©çš„æ—¥æœŸï¼Œå‰‡åˆªé™¤é‚Šæ¡†
function todayEqualActive() {
	setTimeout(function() {
		if ($(".ui-datepicker-current-day").hasClass("ui-datepicker-today")) {
			$(".ui-datepicker-today")
				.children(".ui-state-default")
				.css("border-bottom", "0");
		}
		else {
			$(".ui-datepicker-today")
				.children(".ui-state-default")
				.css("border-bottom", "2px solid rgba(53,60,66,0.5)");
		}
	}, 20);
}


function getTimeSlot(time, duration) {
	// å°‡ time æ‹†è§£ç‚ºå°æ™‚å’Œåˆ†é˜
	const timeParts = time.split(":");
	const hour = parseInt(timeParts[0], 10);
	const minute = parseInt(timeParts[1], 10);

	// å°‡æ™‚é–“è½‰æ›æˆ Date ç‰©ä»¶
	const startTime = new Date(1970, 0, 1, hour, minute);

	// è¨ˆç®—çµæŸæ™‚é–“
	const endTime = new Date(startTime.getTime() + duration * 60000);

	// æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
	const formatTime = (date) =>
		date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: false });

	// è¿”å›æ™‚é–“æ®µ
	return `${formatTime(startTime)} - ${formatTime(endTime)}`;
}


function updateTimeAndCenter() {
	time = $(".owl-stage .center").text(); // å–å¾—ä¸­å¿ƒçš„æ™‚é–“
	$(".request .time").text(getTimeSlot(time, duration)); // æ›´æ–°æ™‚é–“é¡¯ç¤º

	// æ›´æ–°ä¸­å¿ƒé …ç›®å’Œé„°è¿‘é …ç›®çš„æ¨£å¼
	$(".owl-item").removeClass("center-n");
	center = $(".owl-stage").find(".center");
	center.prev("div").addClass("center-n");
	center.next("div").addClass("center-n");
}


	</script>
</body>

</html>